with gp as(
  select  geolocations.g<%= quote @options.level %> as g, projects.id as p_id
  from geolocations
  inner join geolocations_projects on geolocations.id = geolocations_projects.geolocation_id
  inner join projects on projects.id = geolocations_projects.project_id
  where projects.end_date > now() AND projects.start_date <= now()
  <%= @options.conditions %>
  ),
regions as(
  select geolocations.latitude as latitude, geolocations.longitude as longitude, geolocations.name as name, geolocations.uid as uid, geolocations.id as id
  from geolocations
  where geolocations.adm_level=<%= quote @options.level %>
  )
select regions.name, regions.latitude, regions.longitude, regions.uid, regions.id, count(distinct(gp.p_id)) as projects_count from regions
inner join gp on regions.uid = gp.g
group by regions.id, regions.name, regions.uid, regions.latitude, regions.longitude
order by projects_count DESC